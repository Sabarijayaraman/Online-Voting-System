import java.sql.*;
import java.util.*;

public class VotingSystem {

    static Scanner sc = new Scanner(System.in);

    public static void main(String[] args) throws Exception {
        System.out.println("===== ONLINE VOTING SYSTEM =====");

        System.out.print("Enter Voter Name: ");
        String name = sc.nextLine();

        System.out.print("Enter Password: ");
        String pass = sc.nextLine();

        int voterId = authenticate(name, pass);

        if (voterId == -1) {
            System.out.println("Invalid login!");
            return;
        }

        if (hasVoted(voterId)) {
            System.out.println("You have already voted!");
            return;
        }

        vote(voterId);
        System.out.println("Vote cast successfully!\n");

        showResults();
    }

    // Authenticate voter
    public static int authenticate(String name, String password) throws Exception {
        Connection conn = DBConnection.getConnection();
        String sql = "SELECT voterId FROM voters WHERE name=? AND password=?";
        PreparedStatement ps = conn.prepareStatement(sql);
        ps.setString(1, name);
        ps.setString(2, password);

        ResultSet rs = ps.executeQuery();

        if (rs.next())
            return rs.getInt("voterId");

        return -1;
    }

    // Check if already voted
    public static boolean hasVoted(int voterId) throws Exception {
        Connection conn = DBConnection.getConnection();
        String sql = "SELECT hasVoted FROM voters WHERE voterId=?";
        PreparedStatement ps = conn.prepareStatement(sql);
        ps.setInt(1, voterId);

        ResultSet rs = ps.executeQuery();
        if (rs.next())
            return rs.getBoolean("hasVoted");

        return false;
    }

    // Cast vote
    public static void vote(int voterId) throws Exception {
        Connection conn = DBConnection.getConnection();

        System.out.println("\n--- Candidates ---");
        Statement st = conn.createStatement();
        ResultSet rs = st.executeQuery("SELECT * FROM candidates");

        while (rs.next()) {
            System.out.println(rs.getInt("candidateId") + ". " +
                    rs.getString("name") + " (" +
                    rs.getString("party") + ")");
        }

        System.out.print("Enter candidate ID to vote: ");
        int cid = sc.nextInt();

        // Insert vote
        String sql = "INSERT INTO votes(voterId, candidateId) VALUES (?, ?)";
        PreparedStatement ps = conn.prepareStatement(sql);
        ps.setInt(1, voterId);
        ps.setInt(2, cid);
        ps.executeUpdate();

        // Update status
        String sql2 = "UPDATE voters SET hasVoted=TRUE WHERE voterId=?";
        PreparedStatement ps2 = conn.prepareStatement(sql2);
        ps2.setInt(1, voterId);
        ps2.executeUpdate();
    }

    // Show Results
    public static void showResults() throws Exception {
        System.out.println("\n--- Voting Results ---");
        Connection conn = DBConnection.getConnection();
        String sql = """
                SELECT c.name, COUNT(v.candidateId) AS totalVotes
                FROM candidates c
                LEFT JOIN votes v ON c.candidateId = v.candidateId
                GROUP BY c.candidateId
                ORDER BY totalVotes DESC;
                """;

        PreparedStatement ps = conn.prepareStatement(sql);
        ResultSet rs = ps.executeQuery();

        while (rs.next()) {
            System.out.println(rs.getString("name") + " = " +
                    rs.getInt("totalVotes") + " votes");
        }
    }
}
